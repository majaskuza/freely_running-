from pathlib import Path
import numpy as np
import os
import random
from moviepy.editor import VideoFileClip

#converting from mj2 to mp4 format
def convert_to_mp4(subject, date, filenumber):
    mj2_topcam = Path(fr"\\zortex\Subjects\{subject}\{date}\{filenumber}\{date}_{filenumber}_{subject}_topCam.mj2")
    #mj2_topcam = Path(fr"\\zaru.cortexlab.net\Subjects\{subject}\{date}\{filenumber}\{date}_{filenumber}_{subject}_topCam.mj2")
    desktop_path = Path(fr"C:\Users\Experiment\Desktop\mp4\{subject}")
    desktop_path.mkdir(parents=True, exist_ok=True)
    mp4_path = desktop_path / f"{subject}_{date}.mp4"
    ffmpeg_command = f'ffmpeg -i "{mj2_topcam}" -c:v libx264 -crf 23 -c:a aac -strict experimental -b:a 192k "{mp4_path}"'
    os.system(ffmpeg_command)

#cropping videos for DLC analysis
def videocropping(subject, date):
    input_file = fr"C:\Users\Experiment\Desktop\mp4\{subject}\{subject}_{date}.mp4"
    output_dir = fr"C:\Users\Experiment\Desktop\cropped_videos\{subject}"
    Path(output_dir).mkdir(parents=True, exist_ok=True)
    output_file = os.path.join(output_dir, f"cropped_{subject}_{date}.mp4") 
    try:
        duration = VideoFileClip(input_file).duration
        start_time = random.uniform(0, duration - 60)
        ffmpeg_command = f"ffmpeg -ss {start_time} -i \"{input_file}\" -t 60 -c copy \"{output_file}\""
        os.system(ffmpeg_command)
    except Exception as e:
        print(f"Error occurred: {e}")
